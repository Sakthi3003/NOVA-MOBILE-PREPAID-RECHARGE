<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova SIM - Prepaid Recharge App</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Google Font: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="./assets/css/index.css">
    <link rel="icon" href="./assets/images/logo.webp" type="image/x-icon">
    <style>
        /* Add error message styling for Quick Recharge section */
        .quick-recharge .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
            padding: 6px 10px;
            border-radius: 4px;
            background-color: #fff2f2;
            border-left: 2px solid #dc3545;
            animation: shake 0.5s ease-in-out;
        }

        .quick-recharge .error-message:before {
            content: "⚠️ ";
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-3px); }
            40%, 80% { transform: translateX(3px); }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar" id="navbar">
        <a href="index.html" class="logo"><img src="./assets/images/logo.webp" alt="" height="40px" width="100px"></a>
        <button class="mobile-menu-btn" onclick="toggleMenu()">☰</button>
        <div class="nav-links" id="nav-links">
            <!-- Navigation will be populated-->
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h2>POWER UP YOUR CONNECTION <span>ANYTIME, ANYWHERE</span></h2>
            <a href="./subscriber/plans.html"><button class="btn-recharge" id="rechargeButton">Recharge Now</button></a>
        </div>
    </div>

    <!-- Quick Recharge Section -->
    <section class="quick-recharge">
        <div class="container">
            <h3>RECHARGE NOW IN SECONDS!</h3>
            <div class="form-container">
                <form id="phoneForm">
                    <div class="form-group">
                        <div class="input-group">
                            <span class="input-group-text">+91</span>
                            <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" placeholder="10-digit mobile number" maxlength="10" required>
                        </div>
                        <div class="error-message" id="phoneError"></div>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Popular Plans -->
    <section class="popular-plans py-5">
        <div class="container">
            <h2 class="text-center mb-4">Discover Your Perfect Plan Today</h2>
            <div class="plans-section">
                <div class="plan-card" onclick="setCurrentPage('plans')">
                    <h3>Unlimited Plan <i class="fas fa-infinity"></i></h3>
                    <div class="plan-price">₹399</div>
                    <div class="plan-details">
                        <div class="plan-detail"><i class="fas fa-calendar-alt"></i> Validity: 28 Days</div>
                        <div class="plan-detail"><i class="fas fa-mobile-alt"></i> Data: 2GB/Day</div>
                        <div class="plan-detail"><i class="fas fa-sms"></i> SMS: 100/Day</div>
                        <div class="plan-detail"><i class="fas fa-phone"></i> Calls: Unlimited</div>
                    </div>
                    <div class="plan-benefits">
                        <ul>
                            <li>Prime Video</li>
                            <li>Jio Hotstar</li>
                        </ul>
                    </div>
                    <button>View Plans</button>
                </div>
                <div class="plan-card" onclick="setCurrentPage('plans')">
                    <h3>Data Pack <i class="fas fa-wifi"></i></h3>
                    <div class="plan-price">₹249</div>
                    <div class="plan-details">
                        <div class="plan-detail"><i class="fas fa-calendar-alt"></i> Validity: No Expiry</div>
                        <div class="plan-detail"><i class="fas fa-mobile-alt"></i> Data: 10GB Total</div>
                        <div class="plan-detail"><i class="fas fa-sms"></i> SMS: N/A</div>
                        <div class="plan-detail"><i class="fas fa-phone"></i> Calls: N/A</div>
                    </div>
                    <div class="plan-benefits">
                        <ul>
                            <li>Extra Data for Streaming</li>
                            <li>Works with Any Plan</li>
                        </ul>
                    </div>
                    <button>View Plans</button>
                </div>
                <div class="plan-card" onclick="setCurrentPage('plans')">
                    <h3>Validity Pack <i class="fas fa-calendar-alt"></i></h3>
                    <div class="plan-price">₹199</div>
                    <div class="plan-details">
                        <div class="plan-detail"><i class="fas fa-calendar-alt"></i> Validity: 56 Days</div>
                        <div class="plan-detail"><i class="fas fa-mobile-alt"></i> Data: N/A</div>
                        <div class="plan-detail"><i class="fas fa-sms"></i> SMS: N/A</div>
                        <div class="plan-detail"><i class="fas fa-phone"></i> Calls: ₹199 Talktime</div>
                    </div>
                    <div class="plan-benefits">
                        <ul>
                            <li>Extend Plan Validity</li>
                            <li>Talktime</li>
                        </ul>
                    </div>
                    <button>View Plans</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Features Section -->
    <section class="features-section py-5">
        <div class="container">
            <h2 class="pb-2 border-bottom text-center">Why Choose NOVA?</h2>
            <div class="row row-cols-1 row-cols-md-2 align-items-md-center g-5 py-5">
                <div class="col d-flex flex-column align-items-start gap-3">
                    <h2 class="fw-bold">The Ultimate SIM & Recharge Experience</h2>
                    <p>NOVA delivers a seamless mobile recharge and SIM management experience, providing ultra-fast network connectivity and flexible data plans to suit your needs. Log in to track your transactions and stay connected effortlessly.</p>
                    <a href="./login.html" class="btn btn-primary btn-lg">Get Started</a>
                </div>
                <div class="col">
                    <div class="row row-cols-1 row-cols-sm-2 g-4">
                        <div class="col d-flex flex-column gap-2">
                            <div class="feature-icon-small d-inline-flex align-items-center justify-content-center bg-gradient fs-4 rounded-3" style="background-color: #0a21c0;">
                                <i class="fas fa-signal"></i>
                            </div>
                            <h4 class="fw-semibold mb-0">4G & 5G Connectivity</h4>
                            <p>Enjoy ultra-fast internet speeds with our 4G and 5G network coverage.</p>
                        </div>
                        <div class="col d-flex flex-column gap-2">
                            <div class="feature-icon-small d-inline-flex align-items-center justify-content-center bg-gradient fs-4 rounded-3" style="background-color: #0a21c0;">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <h4 class="fw-semibold mb-0">Affordable Plans</h4>
                            <p>Flexible recharge options to fit your budget.</p>
                        </div>
                        <div class="col d-flex flex-column gap-2">
                            <div class="feature-icon-small d-inline-flex align-items-center justify-content-center bg-gradient fs-4 rounded-3" style="background-color: #0a21c0;">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <h4 class="fw-semibold mb-0">Instant Mobile Recharge</h4>
                            <p>Recharge your number within seconds using our fast & secure platform.</p>
                        </div>
                        <div class="col d-flex flex-column gap-2">
                            <div class="feature-icon-small d-inline-flex align-items-center justify-content-center bg-gradient fs-4 rounded-3" style="background-color: #0a21c0;">
                                <i class="fas fa-lock"></i>
                            </div>
                            <h4 class="fw-semibold mb-0">Secure Transactions</h4>
                            <p>Your payments are protected with advanced encryption and security layers.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Buy SIM Section -->
    <section class="buy-sim-section">
        <div class="container">
            <h2>Your Perfect SIM, Ready in a Flash!</h2>
            <p class="lead">We gather your details upfront, so when your SIM lands in your hands, it’s already primed for action. Just pop it in, power up, and dive into seamless connectivity</p>
            <div class="row justify-content-center mb-4">
                <div class="col-md-8 d-flex justify-content-center gap-3">
                    <a href="buy-sim.html" class="btn btn-primary">Buy SIM Now</a>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                <div class="col">
                    <div class="card h-100 text-center shadow-sm">
                        <div class="card-body">
                            <i class="fas fa-shipping-fast fa-2x mb-3"></i>
                            <h5 class="card-title">Fast Delivery</h5>
                            <p class="card-text">Get your SIM delivered to your doorstep within 2-3 days.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 text-center shadow-sm">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-2x mb-3"></i>
                            <h5 class="card-title">Instant Activation</h5>
                            <p class="card-text">No setup required—just insert the SIM and start using it immediately.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 text-center shadow-sm">
                        <div class="card-body">
                            <i class="fas fa-question-circle fa-2x mb-3"></i>
                            <h5 class="card-title">Have Queries?</h5>
                            <p class="card-text">Check our FAQ or reach out for support.</p>
                            <a href="support.html#faq" class="btn btn-link">View FAQs</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Port to Nova Section -->
    <section class="port-to-nova-section">
        <div class="container">
            <h2>Port to Nova</h2>
            <p class="lead">Switch to Nova and keep your number! Enjoy better plans, faster speeds, and top-notch service with a simple porting process.</p>
            <div class="row justify-content-center mb-4">
                <div class="col-md-8 text-center">
                    <a href="port-to-nova.html" class="btn btn-primary">Port Now</a>
                </div>
            </div>
            <div class="row row-cols-1 row-cols-md-3 g-4">
                <div class="col">
                    <div class="card h-100 text-center shadow-sm">
                        <div class="card-body">
                            <i class="fas fa-exchange-alt fa-2x mb-3"></i>
                            <h5 class="card-title">Easy Porting</h5>
                            <p class="card-text">Port your number to Nova in just a few steps.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 text-center shadow-sm">
                        <div class="card-body">
                            <i class="fas fa-tachometer-alt fa-2x mb-3"></i>
                            <h5 class="card-title">Faster Network</h5>
                            <p class="card-text">Experience 4G/5G speeds after switching.</p>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card h-100 text-center shadow-sm">
                        <div class="card-body">
                            <i class="fas fa-question-circle fa-2x mb-3"></i>
                            <h5 class="card-title">Need Help?</h5>
                            <p class="card-text">Get assistance with your porting queries.</p>
                            <a href="support.html#faq" class="btn btn-link">View FAQs</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="index.html">Home</a><br>
                <a href="./subscriber/plans.html">Plans</a><br>
                <a href="./subscriber/support.html">Support</a><br>
                <a href="./subscriber/about.html">About</a><br>
                <a href="./SUBSCRIBER/login.html">Login</a>
            </div>
            <div class="footer-section">
                <h4>Contact Us</h4>
                <p>Email: support@nova.com</p>
                <p>Phone: +91 9876543210</p>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <div class="footer-social">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 Mobi Comm Service Limited. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const guestPages = [
    { id: "home", label: "Home", url: "index.html" },
    { id: "plans", label: "Plans", url: "./subscriber/plans.html" },
    { id: "support", label: "Support", url: "./subscriber/support.html" },
    { id: "About", label: "About Us", url: "./subscriber/about.html" }
];

const loggedInDropdownPages = [
    { id: "myplans", label: "My Plans", url: "./subscriber/myplans.html" },
    { id: "transactions", label: "Transactions", url: "./subscriber/transaction.html" },
    { id: "profile", label: "Profile", url: "./subscriber/profilef.html" },
];

let currentPage = "home";
let isLoggedIn = false;
let userInitials = "U";

// Generate navigation
function generateNavigation() {
    const navLinks = document.getElementById("nav-links");
    navLinks.innerHTML = "";

    // Check localStorage for logged-in state
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    const userDetailsString = sessionStorage.getItem('userDetails');
    let userDetails = null;

    if (userDetailsString) {
        try {
            userDetails = JSON.parse(userDetailsString);
            console.log('Parsed userDetails:', userDetails); // Debugging
        } catch (error) {
            console.error('Error parsing userDetails:', error);
            sessionStorage.removeItem('userDetails');
        }
    } else {
        console.log('userDetails not found in sessionStorage'); // Debugging
    }

    // User is considered logged in if loggedInUser exists in localStorage
    isLoggedIn = !!loggedInUser;
    console.log('isLoggedIn:', isLoggedIn, 'loggedInUser:', loggedInUser); // Debugging

    if (isLoggedIn) {
        // Use first_name for initials (matches backend response)
        userInitials = userDetails?.first_name?.charAt(0)?.toUpperCase() || 'U';
        console.log('userInitials:', userInitials); // Debugging

        // Add guest pages (Home, Plans, Support, About Us)
        guestPages.forEach(page => {
            const link = document.createElement("a");
            link.href = page.url;
            link.className = `nav-link ${currentPage === page.id ? 'active' : ''}`;
            link.textContent = page.label;
            link.onclick = function(e) {
                e.preventDefault();
                setCurrentPage(page.id);
            };
            navLinks.appendChild(link);
        });

        // Add dropdown for logged-in user
        const dropdownDiv = document.createElement('div');
        dropdownDiv.className = 'dropdown';

        const avatar = document.createElement('div');
        avatar.className = 'user-avatar dropdown-toggle';
        avatar.id = 'profileDropdown';
        avatar.setAttribute('data-bs-toggle', 'dropdown');
        avatar.textContent = userInitials;
        dropdownDiv.appendChild(avatar);

        const dropdownMenu = document.createElement('div');
        dropdownMenu.className = 'dropdown-menu dropdown-menu-end';

        loggedInDropdownPages.forEach(page => {
            const link = document.createElement('a');
            link.href = page.url;
            link.className = 'dropdown-item';
            link.textContent = page.label;
            link.onclick = (e) => {
                e.preventDefault();
                setCurrentPage(page.id);
            };
            dropdownMenu.appendChild(link);
        });

        const logoutLink = document.createElement('a');
        logoutLink.href = '#';
        logoutLink.className = 'dropdown-item';
        logoutLink.textContent = 'Logout';
        logoutLink.onclick = (e) => {
            e.preventDefault();
            logout();
        };
        dropdownMenu.appendChild(logoutLink);

        dropdownDiv.appendChild(dropdownMenu);
        navLinks.appendChild(dropdownDiv);
    } else {
        // Guest view: Home, Plans, Support, About Us, Login
        guestPages.forEach(page => {
            const link = document.createElement("a");
            link.href = page.url;
            link.className = `nav-link ${currentPage === page.id ? 'active' : ''}`;
            link.textContent = page.label;
            link.onclick = function(e) {
                e.preventDefault();
                setCurrentPage(page.id);
            };
            navLinks.appendChild(link);
        });

        const loginBtn = document.createElement("a");
        loginBtn.href = "./SUBSCRIBER/login.html"; 
        loginBtn.className = "btn login-btn";
        loginBtn.textContent = "Login";
        navLinks.appendChild(loginBtn);
    }
}

// Set current page and navigate
function setCurrentPage(pageId) {
    currentPage = pageId;
    const guestPage = guestPages.find(p => p.id === pageId);
    const loggedInPage = loggedInDropdownPages.find(p => p.id === pageId);
    if (guestPage) {
        window.location.href = guestPage.url;
    } else if (loggedInPage) {
        window.location.href = loggedInPage.url;
    }
    generateNavigation();
}

// Logout function with loading overlay
function logout() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    // Show the loading overlay
    loadingOverlay.style.display = 'flex';

    // Clear all storage
    localStorage.clear();
    sessionStorage.clear();
    isLoggedIn = false;
    currentPage = 'home';

    // Update navigation immediately
    generateNavigation();

    // Show success message without SweetAlert2
    setTimeout(() => {
        loadingOverlay.style.display = 'none';
        window.location.href = 'index.html';
    }, 1500);
}

// Toggle mobile menu
function toggleMenu() {
    const navLinks = document.getElementById("nav-links");
    navLinks.classList.toggle("active");
}

// Utility function to show error messages
function showError(element, message) {
    element.textContent = message;
    element.style.display = 'block';
}

// Utility function to hide error messages
function hideError(element) {
    element.style.display = 'none';
}

// Phone number validation
function validatePhoneNumber(value) {
    const phoneError = document.getElementById('phoneError');

    if (!value) {
        showError(phoneError, 'Please enter a 10-digit number');
        return false;
    }

    if (/^[0-5]/.test(value)) {
        showError(phoneError, 'Number cannot start with 0-5');
        return false;
    }

    if (value.length < 10) {
        showError(phoneError, 'Please enter a 10-digit number');
        return false;
    }

    if (!/^\d{10}$/.test(value)) {
        showError(phoneError, 'Enter a valid 10-digit number');
        return false;
    }

    hideError(phoneError);
    return true;
}

// Fetch user details from backend API
async function fetchUserDetails(phoneNumber) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const phoneError = document.getElementById('phoneError');

    try {
        loadingOverlay.style.display = 'flex';
        const response = await fetch(`http://localhost:8080/api/user/check-number?number=${phoneNumber}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to fetch user details');
        }

        const userData = await response.json();
        sessionStorage.setItem('userDetails', JSON.stringify(userData));
        sessionStorage.setItem('phoneNumber', phoneNumber);
        sessionStorage.setItem('fromQuickRecharge', 'true');
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            setCurrentPage('plans');
        }, 500);
    } catch (error) {
        console.error('Error fetching user details:', error);
        let errorMessage = 'Phone number not registered.';
        if (error.message.toLowerCase().includes('not found')) {
            errorMessage = 'Phone number not registered. Please sign up.';
        } else if (error.message.toLowerCase().includes('invalid')) {
            errorMessage = 'Invalid phone number format.';
        } else if (error.message.includes('Network')) {
            errorMessage = 'Network error. Please check your connection and try again.';
        } else if (error.message.toLowerCase().includes('failed to fetch user details')) {
            errorMessage = 'Unable to verify the phone number. Please try again later.';
        }
        showError(phoneError, errorMessage);
        loadingOverlay.style.display = 'none';
    }
}

// Initialize and set up event listeners
document.addEventListener('DOMContentLoaded', () => {
    generateNavigation();

    const loadingOverlay = document.getElementById('loadingOverlay');
    const phoneInput = document.getElementById('phoneNumber');

    // Update "Get Started" button immediately after generating navigation
    if (isLoggedIn) {
        const getStartedButton = document.querySelector('.features-section .btn-primary');
        if (getStartedButton) {
            getStartedButton.href = './subscriber/profilef.html';
            getStartedButton.textContent = 'Go to Profile';
        }
    }

    // Dynamic phone number input validation
    phoneInput.addEventListener('input', (e) => {
        let value = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = value.slice(0, 10);

        if (value.length > 0) {
            if (validatePhoneNumber(value) && value.length === 10) {
                fetchUserDetails(value);
            }
        } else {
            showError(document.getElementById('phoneError'), 'Please enter a 10-digit number');
        }
    });

    // Handle Buy SIM and Port Now buttons
    document.querySelectorAll('.btn-primary, .btn-track').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            loadingOverlay.style.display = 'flex';
            const url = button.getAttribute('href');
            setTimeout(() => {
                window.location.href = url;
            }, 1000);
        });
    });
});
    </script>
</body>
</html>