<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova SIM - Payment</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Google Font: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Existing CSS -->
    <link rel="stylesheet" href="../assets/css/payment.css">
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar" id="navbar">
        <a href="../index.html" class="logo"><img src="../assets/images/logo.webp" alt="" height="40px" width="100px"></a>
        <button class="mobile-menu-btn" onclick="toggleMenu()">☰</button>
        <div class="nav-links" id="nav-links">
            <!-- Navigation links will be dynamically generated -->
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb-list" id="breadcrumbList">
                <li class="breadcrumb-item"><a href="plans.html">Plans</a></li>
                <li class="breadcrumb-item active" aria-current="page">Payment</li>
            </ol>
        </nav>
    </div>

    <!-- Payment Page -->
    <div class="payment-page">
        <div class="container">
            <div class="payment-details">
                <div class="customer-info">
                    <div class="customer-avatar" id="customerAvatar"></div>
                    <div class="customer-text">
                        <h3 id="customerName"></h3>
                        <p id="customerNumber"></p>
                    </div>
                </div>
                
                <div class="recharge-details">
                    <a href="javascript:history.back()" class="logo" style="color: blue; padding: 20px;"><i class="fas fa-arrow-left"></i></a>
                    <h2>Recharge Details</h2>
                    <div class="plan-badge" id="planName"></div>
                    
                    <div class="detail-item">
                        <span class="label">Data</span>
                        <span id="planData"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Validity</span>
                        <span id="planValidity"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">Voice Calls</span>
                        <span id="planCalls"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">SMS</span>
                        <span id="planSMS"></span>
                    </div>
                </div>
                
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="detail-item">
                        <span class="label">Plan Price</span>
                        <span id="planPrice"></span>
                    </div>
                    <div class="detail-item">
                        <span class="label">GST (18%)</span>
                        <span id="gstAmount"></span>
                    </div>
                    <div class="detail-item total-amount">
                        <span class="label">Total</span>
                        <span id="totalAmount"></span>
                    </div>
                </div>
                
                <div class="customer-support">
                    <p>Need help? <a href="support.html">Contact customer support</a></p>
                </div>
            </div>
            
            <div class="payment-methods">
                <h1>Proceed to Payment</h1>
                <div class="payment-footer">
                    <button class="submit-btn" id="payRazorpayBtn">Pay with Razorpay <span id="payRazorpayAmount"></span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-section">
                <h4>Explore</h4>
                <a href="../index.html">Home</a><br>
                <a href="./plans.html">Plans</a><br>
                <a href="./support.html">Support</a><br>
                <a href="./about.html">About Us</a><br>
                <a href="./login.html">Login</a>
            </div>
            <div class="footer-section">
                <h4>Get Started</h4>
                <a href="./buy-sim.html">Get sim</a><br>
                <a href="./port.html">Switch to NOVA</a><br>
            </div>
            <div class="footer-section">
                <h4>Contact Us</h4>
                <p>Email: support@nova.com</p>
                <p>Phone: +91 9876543210</p>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <div class="footer-social">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2025 Mobi Comm Service Limited. All rights reserved.</p>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <!-- Razorpay Checkout.js -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        // Pages configuration (unchanged from original)
        const guestPages = [
            { id: "home", label: "Home", url: "../index.html" },
            { id: "plans", label: "Plans", url: "./plans.html" },
            { id: "support", label: "Support", url: "./support.html" },
            { id: "about", label: "About Us", url: "./about.html" }
        ];

        const loggedInDropdownPages = [
            { id: "myplans", label: "My Plans", url: "./myplans.html" },
            { id: "transactions", label: "Transactions", url: "./transaction.html" },
            { id: "profile", label: "Profile", url: "./profile.html" },
        ];

        let currentPage = "payment";
        let isLoggedIn = false;
        let userInitials = "U";
        let paymentMethod = "RAZORPAY"; // Set to Razorpay since it's the only method

        // Utility function for fetching with timeout (unchanged from original)
        async function fetchWithTimeout(url, options, timeout = 10000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. Please check your internet connection and try again.');
                }
                throw error;
            }
        }

        // Check if user is logged in based on access token (unchanged from original)
        function checkLoginStatus() {
            const accessToken = localStorage.getItem('accessToken');
            isLoggedIn = !!accessToken;
            if (isLoggedIn) {
                const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
                userInitials = loggedInUser?.simHolderName?.charAt(0).toUpperCase() || 'U';
            }
        }

        // Generate navigation (unchanged from original)
        function generateNavigation() {
            const navLinks = document.getElementById("nav-links");
            navLinks.innerHTML = "";

            if (isLoggedIn) {
                guestPages.forEach(page => {
                    const link = document.createElement("a");
                    link.href = page.url;
                    link.className = `nav-link ${currentPage === page.id ? 'active' : ''}`;
                    link.textContent = page.label;
                    link.onclick = function(e) {
                        e.preventDefault();
                        setCurrentPage(page.id);
                    };
                    navLinks.appendChild(link);
                });

                const dropdownDiv = document.createElement('div');
                dropdownDiv.className = 'dropdown';

                const avatar = document.createElement('div');
                avatar.className = 'user-avatar dropdown-toggle';
                avatar.id = 'profileDropdown';
                avatar.setAttribute('data-bs-toggle', 'dropdown');
                avatar.textContent = userInitials;
                dropdownDiv.appendChild(avatar);

                const dropdownMenu = document.createElement('div');
                dropdownMenu.className = 'dropdown-menu dropdown-menu-end';

                loggedInDropdownPages.forEach(page => {
                    const link = document.createElement('a');
                    link.href = page.url;
                    link.className = 'dropdown-item';
                    link.textContent = page.label;
                    link.onclick = (e) => {
                        e.preventDefault();
                        setCurrentPage(page.id);
                    };
                    dropdownMenu.appendChild(link);
                });

                const logoutLink = document.createElement('a');
                logoutLink.href = '#';
                logoutLink.className = 'dropdown-item';
                logoutLink.textContent = 'Logout';
                logoutLink.onclick = (e) => {
                    e.preventDefault();
                    logout();
                };
                dropdownMenu.appendChild(logoutLink);

                dropdownDiv.appendChild(dropdownMenu);
                navLinks.appendChild(dropdownDiv);
            } else {
                guestPages.forEach(page => {
                    const link = document.createElement("a");
                    link.href = page.url;
                    link.className = `nav-link ${currentPage === page.id ? 'active' : ''}`;
                    link.textContent = page.label;
                    link.onclick = function(e) {
                        e.preventDefault();
                        setCurrentPage(page.id);
                    };
                    navLinks.appendChild(link);
                });

                const loginBtn = document.createElement("a");
                loginBtn.href = "./login.html";
                loginBtn.className = "btn login-btn";
                loginBtn.textContent = "Login";
                navLinks.appendChild(loginBtn);
            }
        }

        // Set current page and navigate (unchanged from original)
        function setCurrentPage(pageId) {
            currentPage = pageId;
            const guestPage = guestPages.find(p => p.id === pageId);
            const loggedInPage = loggedInDropdownPages.find(p => p.id === pageId);
            if (guestPage) {
                window.location.href = guestPage.url;
            } else if (loggedInPage) {
                window.location.href = loggedInPage.url;
            }
            generateNavigation();
        }

        // Logout function with SweetAlert2 and loading overlay (unchanged from original)
        function logout() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            localStorage.removeItem('accessToken');
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('profileSetup');
            sessionStorage.removeItem('phoneNumber');
            sessionStorage.clear();
            isLoggedIn = false;
            currentPage = 'home';
            generateNavigation();

            Swal.fire({
                icon: 'success',
                title: 'Logged Out',
                text: 'You have been logged out successfully.',
                confirmButtonText: 'OK',
                confirmButtonColor: '#0a21c0',
                timer: 1500,
                timerProgressBar: true,
                willClose: () => {
                    loadingOverlay.style.display = 'none';
                    window.location.href = '../index.html';
                }
            });
        }

        // Toggle mobile menu (unchanged from original)
        function toggleMenu() {
            const navLinks = document.getElementById("nav-links");
            navLinks.classList.toggle("active");
        }

        // Display user details and plan details using sessionStorage (unchanged from original)
        function displayUserDetails() {
            const mobileNumber = sessionStorage.getItem('phoneNumber');
            const selectedPlan = JSON.parse(sessionStorage.getItem('selectedPlan'));
            const userDetails = JSON.parse(sessionStorage.getItem('userDetails'));

            if (!mobileNumber || !selectedPlan || !userDetails) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Plan, mobile number, or user details not found. Please select a plan again.',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#0a21c0'
                }).then(() => {
                    window.location.href = 'plans.html';
                });
                return;
            }

            // Display user details
            const fullName = `${userDetails.firstName} ${userDetails.lastName}`;
            $('#customerName').text(fullName);
            $('#customerNumber').text(`+91 ${mobileNumber}`);
            const initials = fullName.split(' ').map(word => word[0]).join('').toUpperCase();
            $('#customerAvatar').text(initials);

            // Display plan details
            $('#planName').text(selectedPlan.name);
            $('#planData').text(selectedPlan.data);
            $('#planValidity').text(selectedPlan.validity);
            $('#planCalls').text(selectedPlan.calls);
            $('#planSMS').text(selectedPlan.sms);

            // Calculate GST and total
            const planPrice = parseFloat(selectedPlan.price);
            const gstRate = 0.18; // 18% GST
            const gstAmount = planPrice * gstRate;
            const totalAmount = planPrice + gstAmount;

            $('#planPrice').text(`₹${planPrice.toFixed(2)}`);
            $('#gstAmount').text(`₹${gstAmount.toFixed(2)}`);
            $('#totalAmount').text(`₹${totalAmount.toFixed(2)}`);
            $('#payRazorpayAmount').text(`₹${totalAmount.toFixed(2)}`);
        }

        // Generate a random reference number (unchanged from original)
        function generateRefNo() {
            return `REF${new Date().getFullYear()}${String(new Date().getMonth() + 1).padStart(2, '0')}${String(new Date().getDate()).padStart(2, '0')}${Math.floor(100000 + Math.random() * 900000)}`;
        }

        // Format current date as DD Mon YYYY (unchanged from original)
        function formatDate() {
            const date = new Date();
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return `${String(date.getDate()).padStart(2, '0')} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        // Format current time as HH:MM:SS IST (unchanged from original)
        function formatTime() {
            const date = new Date();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds} IST`;
        }

        // Process payment by calling the backend API (unchanged from original)
        async function confirmPayment(razorpayPaymentId) {
            const userDetails = JSON.parse(sessionStorage.getItem('userDetails'));
            const selectedPlan = JSON.parse(sessionStorage.getItem('selectedPlan'));
            const phoneNumber = sessionStorage.getItem('phoneNumber');
            const loadingOverlay = document.getElementById('loadingOverlay');

            // Validate all required data
            if (!userDetails || !selectedPlan || !phoneNumber || !paymentMethod) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Missing required data. Please try again.',
                    confirmButtonColor: '#0a21c0'
                }).then(() => {
                    window.location.href = 'plans.html';
                });
                return;
            }

            // Ensure all fields are present and in the correct format
            const rechargeData = {
                userId: userDetails.userId ? String(userDetails.userId) : null, // Use userId from userDetails
                planId: selectedPlan.id ? String(selectedPlan.id) : null, // Use planId from selectedPlan
                phoneNumber: phoneNumber ? String(phoneNumber) : null,
                paymentMethod: paymentMethod ? paymentMethod.toUpperCase() : null
            };

            // Validate the payload
            if (!rechargeData.userId || !rechargeData.planId || !rechargeData.phoneNumber || !rechargeData.paymentMethod) {
                console.error('Invalid recharge data:', rechargeData);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Invalid recharge data. Please try again.',
                    confirmButtonColor: '#0a21c0'
                });
                return;
            }

            // Log the payload for debugging
            console.log('Sending recharge request with payload:', rechargeData);

            loadingOverlay.style.display = 'flex'; // Show loading overlay

            try {
                const response = await fetchWithTimeout('http://localhost:8080/api/recharge/recharge', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // Uncomment if authentication is required
                        // 'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                    },
                    body: JSON.stringify(rechargeData)
                });

                // Log the raw response for debugging
                console.log('Raw response:', response);

                // Check if the response is OK
                if (!response.ok) {
                    let errorMessage = 'Failed to process recharge';
                    try {
                        const errorData = await response.json();
                        console.log('Error response data:', errorData);
                        errorMessage = errorData.message || `Server error: ${response.status}`;
                    } catch (jsonError) {
                        console.error('Error parsing error response:', jsonError);
                        errorMessage = `Server error: ${response.status} - Unable to parse response`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('Success response data:', result);
                if (result.status !== 'Success') {
                    throw new Error(result.message || 'Recharge failed');
                }

                const planPrice = parseFloat(selectedPlan.price);
                const gstRate = 0.18;
                const totalAmount = planPrice + (planPrice * gstRate);

                const transactionDetails = {
                    mobileNumber: `+91 ${phoneNumber}`,
                    customerName: `${userDetails.firstName} ${userDetails.lastName}`,
                    amount: `₹${totalAmount.toFixed(2)}`,
                    refNo: generateRefNo(),
                    txnId: razorpayPaymentId || result.transactionId, // Use Razorpay payment ID if available
                    date: formatDate(),
                    time: formatTime(),
                    paymentMode: paymentMethod
                };

                // Store transaction details in sessionStorage
                sessionStorage.setItem('transactionDetails', JSON.stringify(transactionDetails));

                // Redirect to success page
                window.location.href = 'success.html';
            } catch (error) {
                console.error('Error processing recharge:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Recharge Failed',
                    text: error.message || 'An error occurred while processing your recharge. Please try again.',
                    confirmButtonColor: '#0a21c0'
                });
            } finally {
                loadingOverlay.style.display = 'none'; // Hide loading overlay
            }
        }

        // Razorpay Payment Integration
        async function initiateRazorpayPayment() {
            const userDetails = JSON.parse(sessionStorage.getItem('userDetails'));
            const selectedPlan = JSON.parse(sessionStorage.getItem('selectedPlan'));
            const phoneNumber = sessionStorage.getItem('phoneNumber');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (!userDetails || !selectedPlan || !phoneNumber) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Missing required data. Please try again.',
                    confirmButtonColor: '#0a21c0'
                }).then(() => {
                    window.location.href = 'plans.html';
                });
                return;
            }

            const planPrice = parseFloat(selectedPlan.price);
            const totalAmount = (planPrice + planPrice * 0.18) * 100; // Convert to paise

            const options = {
                key: "rzp_test_swf3FXzw0ItrnX",
                amount: totalAmount,
                currency: "INR",
                name: "Nova SIM",
                description: `Recharge for ${selectedPlan.name}`,
                image: "../assets/images/logo.webp",
                handler: async function (response) {
                    // On successful payment, call the original confirmPayment function
                    await confirmPayment(response.razorpay_payment_id);
                },
                prefill: {
                    name: `${userDetails.firstName} ${userDetails.lastName}`,
                    email: userDetails.email || "customer@example.com",
                    contact: phoneNumber
                },
                theme: {
                    color: "#0a21c0"
                },
                modal: {
                    ondismiss: function () {
                        loadingOverlay.style.display = 'none';
                        Swal.fire({
                            icon: 'info',
                            title: 'Payment Cancelled',
                            text: 'You cancelled the payment. Please try again.',
                            confirmButtonColor: '#0a21c0'
                        });
                    }
                }
            };

            try {
                loadingOverlay.style.display = 'flex';
                const rzp = new Razorpay(options);
                rzp.open();
            } catch (error) {
                loadingOverlay.style.display = 'none';
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to initialize payment. Please check your internet connection and try again.',
                    confirmButtonColor: '#0a21c0'
                });
            }
        }

        // Update breadcrumb to show only Plans > Payment (unchanged from original)
        function updateBreadcrumb() {
            const breadcrumbList = $('#breadcrumbList');
            breadcrumbList.empty(); // Clear existing breadcrumb items

            // Show Plans > Payment
            const plansItem = `<li class="breadcrumb-item"><a href="plans.html">Plans</a></li>`;
            const paymentItem = `<li class="breadcrumb-item active" aria-current="page">Payment</li>`;
            breadcrumbList.append(plansItem).append(paymentItem);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Check login status
            checkLoginStatus();

            // Generate navigation
            generateNavigation();

            // Display user and plan details
            displayUserDetails();

            // Update breadcrumb
            updateBreadcrumb();

            // Razorpay payment button handler
            const payRazorpayBtn = document.getElementById('payRazorpayBtn');
            payRazorpayBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await initiateRazorpayPayment();
            });
        });
    </script>
</body>
</html>