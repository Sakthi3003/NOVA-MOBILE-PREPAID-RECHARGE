<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Success - Nova SIM</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Google Fonts: Poppins and Dancing Script -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Existing CSS -->
    <link rel="stylesheet" href="../assets/css/success.css">
    <style>
        /* Ensure long text wraps in the invoice table */
        .invoice-table td {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        /* Style the breadcrumb */
        .breadcrumb {
            background-color: #f8f9fa; /* Light background */
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <!-- Success Content -->
    <div class="success-container">
        <a href="javascript:history.back()" class="logo" style="color: blue; padding: 20px;"><i class="fas fa-arrow-left"></i></a>
        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html">Plans</a></li>
                <li class="breadcrumb-item"><a href="payment.html">Payment</a></li>
                <li class="breadcrumb-item active" aria-current="page">Success</li>
            </ol>
        </nav>

        <div class="success-header">
            <i class="fas fa-check-circle success-icon"></i>
            <h1>Payment Successful!</h1>
            <p class="success-message">Your recharge has been processed successfully!</p>
        </div>

        <div class="transaction-card">
            <p><strong>Name:</strong> <span id="customerName"></span></p>
            <p><strong>Mobile Number:</strong> <span id="mobileNumber"></span></p>
            <p><strong>Amount:</strong> <span id="amount"></span></p>
            <p><strong>Reference No:</strong> <span id="refNo"></span></p>
            <p><strong>Date:</strong> <span id="date"></span></p>
            <p><strong>Time:</strong> <span id="time"></span></p>
            <p><strong>Payment Method:</strong> <span id="paymentMethod"></span></p>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="downloadInvoiceBtn">Download Invoice</button>
            <button class="btn btn-secondary" id="shareEmailBtn"><i class="fas fa-envelope"></i> Share via Email</button>
            <button class="btn btn-primary" id="goToHomeBtn">Go to Home</button>
        </div>
    </div>

    <div id="invoice">
        <!-- Invoice Header -->
        <div class="invoice-header">
            <div class="invoice-logo">
                <img src="../assets/images/logo.webp" alt="Nova SIM Logo" width="190" height="60">
            </div>
            <div class="invoice-title">PAYMENT RECEIPT</div>
        </div>
        
        <!-- Invoice Body -->
        <div class="invoice-body">
            <!-- Invoice Meta Information -->
            <div class="invoice-meta">
                <div class="invoice-meta-item">
                    <div class="invoice-meta-label">Receipt No.</div>
                    <div class="invoice-meta-value" id="invoiceRefNo"></div>
                </div>
                <div class="invoice-meta-item">
                    <div class="invoice-meta-label">Transaction Date</div>
                    <div class="invoice-meta-value" id="invoiceDateTime"></div>
                </div>
                <div class="invoice-meta-item">
                    <div class="invoice-meta-label">Payment Mode</div>
                    <div class="invoice-meta-value" id="invoicePaymentMethod"></div>
                </div>
            </div>
            
            <!-- Customer Details Section -->
            <div class="invoice-section">
                <div class="invoice-section-title">CUSTOMER DETAILS</div>
                <table class="invoice-table">
                    <tr>
                        <td width="30%"><strong>Customer Name</strong></td>
                        <td width="70%" id="invoiceCustomerName"></td>
                    </tr>
                    <tr>
                        <td><strong>Mobile Number</strong></td>
                        <td id="invoiceMobileNumber"></td>
                    </tr>
                </table>
            </div>
            
            <!-- Plan Details Section -->
            <div class="invoice-section">
                <div class="invoice-section-title">PLAN DETAILS</div>
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Pack Description</th>
                            <th>Data</th>
                            <th>Validity</th>
                            <th>Voice</th>
                            <th>SMS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td id="invoicePlanName"></td>
                            <td id="invoiceData"></td>
                            <td id="invoiceValidity"></td>
                            <td id="invoiceCalls"></td>
                            <td id="invoiceSMS"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Payment Details Section -->
            <div class="invoice-section">
                <div class="invoice-section-title">PAYMENT DETAILS</div>
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Base Pack Amount</td>
                            <td id="invoiceBaseAmount"></td>
                        </tr>
                        <tr>
                            <td>GST (18%)</td>
                            <td id="invoiceGST"></td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Total Amount</strong></td>
                            <td id="invoiceTotalAmount"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Footer with Signature -->
            <div class="invoice-footer">
                <div class="signature-container">
                    <div class="signature-box">
                        <div class="signature-text">
                            <p>Digitally signed by Mobi Comm Service Limited</p>
                            <p>Date: 2025.02.27</p>
                            <p>Reason: Invoice</p>
                            <p class="dynamic-time"></p>
                        </div>
                    </div>
                </div>
                <p>Thank you for choosing Nova. For any assistance, please contact our customer support.</p>
                <p>Email: support@nova.com | Helpline: +91 987654321</p>
                <p>© 2025 Mobi Comm Service Limited. All rights reserved.</p>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script>
        $(document).ready(function() {
            // Utility function for fetching with timeout
            async function fetchWithTimeout(url, options, timeout = 10000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    clearTimeout(id);
                    return response;
                } catch (error) {
                    clearTimeout(id);
                    if (error.name === 'AbortError') {
                        throw new Error('Request timed out. Please check your internet connection and try again.');
                    }
                    throw error;
                }
            }

            // Retrieve transaction details from sessionStorage
            const transactionDetails = JSON.parse(sessionStorage.getItem('transactionDetails'));
            const userDetails = JSON.parse(sessionStorage.getItem('userDetails'));
            const selectedPlan = JSON.parse(sessionStorage.getItem('selectedPlan'));

            if (!transactionDetails || !userDetails || !selectedPlan) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Transaction details not found. Please try again.',
                    confirmButtonColor: '#0a21c0',
                    position: 'center',
                    zIndex: 3001
                }).then(() => {
                    window.location.href = 'plans.html';
                });
                return;
            }

            // Display transaction details on the success page
            $('#customerName').text(transactionDetails.customerName || 'Unknown');
            $('#mobileNumber').text(transactionDetails.mobileNumber || 'N/A');
            $('#amount').text(transactionDetails.amount || '₹0.00');
            $('#refNo').text(transactionDetails.refNo || 'N/A');
            $('#date').text(transactionDetails.date || 'N/A');
            $('#time').text(transactionDetails.time || 'N/A');
            $('#paymentMethod').text(transactionDetails.paymentMode || 'Unknown');

            // Populate invoice template
            $('#invoiceCustomerName').text(`${userDetails.firstName || ''} ${userDetails.lastName || ''}`.trim() || 'Unknown');
            $('#invoiceMobileNumber').text(userDetails.phone_number ? `+91 ${userDetails.phone_number}` : 'N/A');
            $('#invoiceRefNo').text(transactionDetails.refNo || 'N/A');
            $('#invoiceDateTime').text(`${transactionDetails.date} ${transactionDetails.time}` || 'N/A');
            $('#invoicePaymentMethod').text(transactionDetails.paymentMode || 'Unknown');
            $('#invoicePlanName').text(selectedPlan.name || 'N/A');
            $('#invoiceData').text(selectedPlan.data || 'N/A');
            $('#invoiceValidity').text(selectedPlan.validity || 'N/A');
            $('#invoiceCalls').text(selectedPlan.calls || 'N/A');
            $('#invoiceSMS').text(selectedPlan.sms || 'N/A');

            const planPrice = parseFloat(selectedPlan.price || 0);
            const gstRate = 0.18;
            const gstAmount = planPrice * gstRate;
            const totalAmount = planPrice + gstAmount;

            $('#invoiceBaseAmount').text(`${planPrice.toFixed(2)}`);
            $('#invoiceGST').text(`${gstAmount.toFixed(2)}`);
            $('#invoiceTotalAmount').text(`${totalAmount.toFixed(2)}`);

            // Go to Home button
            $('#goToHomeBtn').on('click', function() {
                // Clear sessionStorage to prevent stale data
                sessionStorage.removeItem('selectedPlan');
                sessionStorage.removeItem('userDetails');
                sessionStorage.removeItem('phoneNumber');
                sessionStorage.removeItem('transactionDetails');
                sessionStorage.removeItem('fromQuickRecharge');
                window.location.href = '../index.html';
            });

            // Download Invoice button
            $('#downloadInvoiceBtn').on('click', function() {
                generateInvoice();
            });

            // Share via Email button
            $('#shareEmailBtn').on('click', async function() {
                const invoiceData = {
                    email: userDetails.email || prompt('Please enter your email address:'),
                    customerName: transactionDetails.customerName,
                    mobileNumber: transactionDetails.mobileNumber,
                    amount: transactionDetails.amount,
                    refNo: transactionDetails.refNo,
                    date: transactionDetails.date,
                    time: transactionDetails.time,
                    paymentMode: transactionDetails.paymentMode,
                    planName: selectedPlan.name,
                    data: selectedPlan.data,
                    validity: selectedPlan.validity,
                    calls: selectedPlan.calls,
                    sms: selectedPlan.sms,
                    baseAmount: planPrice.toFixed(2),
                    gst: gstAmount.toFixed(2),
                    totalAmount: totalAmount.toFixed(2)
                };

                if (!invoiceData.email) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Email Required',
                        text: 'Please provide an email address to share the invoice.',
                        confirmButtonColor: '#0a21c0',
                        position: 'center',
                        zIndex: 3001
                    });
                    return;
                }

                try {
                    const response = await fetchWithTimeout('http://localhost:8080/api/invoice/email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // 'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                        },
                        body: JSON.stringify(invoiceData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to send invoice via email');
                    }

                    const result = await response.json();
                    if (result.status !== 'SUCCESS') {
                        throw new Error(result.message || 'Failed to send invoice via email');
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'Invoice Sent',
                        text: `The invoice has been sent to ${invoiceData.email}.`,
                        confirmButtonColor: '#0a21c0',
                        position: 'center',
                        zIndex: 3001
                    });
                } catch (error) {
                    console.error('Error sending invoice via email:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'Failed to send invoice via email. Please try again.',
                        confirmButtonColor: '#0a21c0',
                        position: 'center',
                        zIndex: 3001
                    });
                }
            });

            // Invoice generation function
            function generateInvoice() {
                $('#invoice').css('display', 'block');
                
                const element = document.getElementById('invoice');
                // Sanitize mobile number for filename
                const mobileNumber = transactionDetails.mobileNumber.replace(/[^0-9]/g, ''); // e.g., "+91 9487381354" -> "919487381354"
                const opt = {
                    margin: 10,
                    filename: `Nova_SIM_Invoice_${mobileNumber}.pdf`, // Updated to use mobile number
                    image: { type: 'jpeg', quality: 1 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().from(element).set(opt).save()
                    .then(() => {
                        console.log('Invoice generated and downloaded successfully.');
                        $('#invoice').css('display', 'none');
                    })
                    .catch((error) => {
                        console.error('Error generating invoice:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: `Failed to generate invoice. Details: ${error.message}`,
                            confirmButtonColor: '#0a21c0',
                            position: 'center',
                            zIndex: 3001
                        });
                        $('#invoice').css('display', 'none');
                    });
            }

            // Dynamic time update
            function updateDynamicTime() {
                const now = new Date('2025-03-05T' + new Date().toTimeString().split(' ')[0]); // Use March 5, 2025, with current time
                const timeString = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit', timeZone: 'Asia/Kolkata' });
                $('.dynamic-time').text(`Time: ${timeString} IST`);
            }

            // Call the function when the page loads and update every second
            updateDynamicTime();
            setInterval(updateDynamicTime, 1000);
        });
    </script>
</body>
</html>